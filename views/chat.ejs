<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js"
        integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js"
        integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG"
        crossorigin="anonymous"></script>
    <script src="/socket.io/socket.io.js"></script>
    <title>Chat</title>
</head>

<body>
    <% if (locals.user) { %>

        <div id="data" data-user=<%=user%>></div>></div>

        <% } %>

            <div class="container">
                <form id="chatForm">
                    <h2 class="text-center mb-4">Centro de Mensajes</h2>
                    <input class="mb-4 d-grid col-3 mx-auto text-center"
                        placeholder="Ingresa tu username para enviar un mensaje" type="text" name="username"
                        id="username">
                    <div style="overflow-y: scroll;">
                        <ul class="text-center" style="list-style: none; height: 50vh;" id="mensajes">

                        </ul>
                    </div>

                    <div class="text-center">
                        <input class="col-3 mx-auto text-center" type="text" name="msj" id="msj"><button type="submit"
                            class="btn-primary">Enviar</button>
                    </div>

            </div>
            </form>

            <script>
                const socket = io()

                let user

                if (document.querySelector('#data')) {
                    user = document.querySelector('#data').dataset.user
                }

                const chatForm = document.querySelector('#chatForm')
                const username = document.querySelector('#username')
                const chat = document.querySelector('#mensajes')
                const mensaje = document.querySelector('#msj')

                chatForm.addEventListener('submit', e => {
                    e.preventDefault()
                    if (username.value) {
                        const msj = {
                            type: 'user',
                            user: username.value,
                            message: mensaje.value
                        }
                        socket.emit('chat', msj)
                        mensaje.value = ''
                    }
                }
                )
                socket.on('chat', message => {
                    if (user) {
                        if (user === message.user) {
                            let li = document.createElement('li')
                            li.innerHTML = `<span style="color: blue; font-weight: bold;">${message.user}</span><span style="color:green; font-style: italic;">: ${message.message}</span>`
                            chat.appendChild(li)
                        }
                    } else {
                        let li = document.createElement('li')
                        li.innerHTML = `<span style="color: blue; font-weight: bold;">${message.user}</span><span style="color:green; font-style: italic;">: ${message.message}</span>`
                        chat.appendChild(li)
                    }
                })

            </script>

</body>

</html>